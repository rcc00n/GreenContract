{% extends "base.html" %}

{% block content %}
  <div class="row">
    <div class="col-lg-9 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h4 mb-0">{% if object %}Редактировать шаблон{% else %}Новый шаблон{% endif %}</h1>
          <p class="text-muted small mb-0">Поддерживаются веб-шаблоны → ПДФ, документы Ворд и заполнение готовых ПДФ с полями.</p>
        </div>
        <a href="{% url 'rentals:contract_template_list' %}" class="btn btn-outline-secondary">Назад к списку</a>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="row g-3 align-items-start">
              <div class="col-md-6">
                <label class="form-label" for="{{ form.name.id_for_label }}">Название</label>
                {{ form.name }}
                {% for error in form.name.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label" for="{{ form.format.id_for_label }}">Формат</label>
                {{ form.format }}
                <div class="form-text">Веб-шаблон конвертируется в ПДФ, документы Ворд и ПДФ используют загруженный файл.</div>
                {% for error in form.format.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-md-6 format-file">
                <label class="form-label" for="{{ form.file.id_for_label }}">Файл шаблона</label>
                {{ form.file }}
                <div class="form-text">
                  Ворд: будут заменены плейсхолдеры. ПДФ: заполняются поля формы с именами вроде <code>клиент_фио</code>.
                </div>
                {% for error in form.file.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12 format-html">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label mb-0" for="{{ form.body_html.id_for_label }}">Разметка веб-шаблона</label>
                  <span class="badge text-bg-info">Опционально для ПДФ: будет сконвертировано</span>
                </div>
                {{ form.body_html }}
                <div class="form-text">Используйте плейсхолдеры {% templatetag openvariable %} клиент.фио {% templatetag closevariable %} или {% templatetag openvariable %} аренда.номер_договора {% templatetag closevariable %}.</div>
                {% for error in form.body_html.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <label class="form-label" for="{{ form.description.id_for_label }}">Описание</label>
                {{ form.description }}
                {% for error in form.description.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <label class="form-label" for="{{ form.placeholder_help.id_for_label }}">Подсказка внутри шаблона</label>
                {{ form.placeholder_help }}
                {% for error in form.placeholder_help.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
            </div>
            <div class="d-flex justify-content-end gap-2 pt-3">
              <a href="{% url 'rentals:contract_template_list' %}" class="btn btn-outline-secondary">Отмена</a>
              <button class="btn btn-primary" type="submit">Сохранить шаблон</button>
            </div>
          </form>
        </div>
      </div>

      {% if placeholder_guide %}
        <div class="card shadow-sm mt-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <div class="fw-semibold">Быстрая вставка плейсхолдеров</div>
                <div class="text-muted small">Нажмите на бейдж, чтобы скопировать значение в буфер. Первый бейдж — для веб-шаблона/Ворда, второй — имя поля для ПДФ-форм.</div>
              </div>
              <div class="text-muted small" id="templateFormatHint">Формат: Веб-шаблон</div>
            </div>
            <div class="row g-3">
              {% for group in placeholder_guide %}
                <div class="col-md-4">
                  <div class="placeholder-card h-100 p-3 border rounded">
                    <div class="fw-semibold mb-2">{{ group.title }}</div>
                    <div class="d-flex flex-column gap-2">
                      {% for item in group.items %}
                        <div class="placeholder-row">
                          <div class="fw-semibold small text-truncate">{{ item.description }}</div>
                          <div class="d-flex flex-wrap gap-2 mt-1">
                            <span class="badge text-bg-primary placeholder-copy" data-copy-placeholder="{{ item.token }}" title="Веб-шаблон/Ворд">{{ item.token }}</span>
                            <span class="badge text-bg-secondary placeholder-copy" data-copy-placeholder="{{ item.alt }}" title="Поле формы ПДФ">{{ item.alt }}</span>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="fw-semibold">Шаблон-рыба для быстрого старта</div>
              <div class="text-muted small">Скопируйте и вставьте в веб-шаблон, Ворд или как подсказку к полям ПДФ.</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" type="button" data-copy-template="#contractSnippet">Скопировать пример</button>
          </div>
          {% verbatim %}
          <pre class="bg-body-tertiary rounded p-3 small" id="contractSnippet">Договор № {{ аренда.номер_договора }}
г. {{ клиент.адрес_регистрации }}

Арендодатель передает во временное пользование автомобиль {{ авто.марка }} {{ авто.модель }} ({{ авто.госномер }}) сроком с {{ аренда.дата_начала }} по {{ аренда.дата_окончания }}.

Арендатор: {{ клиент.фио }}, паспорт {{ клиент.паспорт_серия }} {{ клиент.паспорт_номер }}, выдан {{ клиент.паспорт_дата_выдачи }} {{ клиент.паспорт_кем_выдан }}. Телефон: {{ клиент.телефон }}.

Стоимость проката: {{ аренда.итоговая_сумма }}, предоплата: {{ аренда.предоплата }}, к оплате при возврате: {{ аренда.к_оплате }}.</pre>
          {% endverbatim %}
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const formatSelect = document.getElementById("id_format");
      const formatHint = document.getElementById("templateFormatHint");
      const formatLabels = {
        html: "Веб-шаблон",
        docx: "Документ Ворд",
        pdf: "ПДФ-форма",
      };

      const toggleSections = () => {
        const value = formatSelect?.value || "html";
        document.querySelectorAll(".format-html").forEach((el) => el.classList.toggle("d-none", value === "docx"));
        document.querySelectorAll(".format-file").forEach((el) => el.classList.toggle("d-none", value === "html"));
        if (formatHint) formatHint.textContent = `Формат: ${formatLabels[value] || formatLabels.html}`;
      };
      formatSelect?.addEventListener("change", toggleSections);
      toggleSections();

      const notifyCopy = (target) => {
        target.classList.add("copied");
        setTimeout(() => target.classList.remove("copied"), 1200);
      };

      document.querySelectorAll(".placeholder-copy").forEach((badge) => {
        badge.addEventListener("click", () => {
          const text = badge.dataset.copyPlaceholder;
          if (!text) return;
          navigator.clipboard?.writeText(text.trim());
          notifyCopy(badge);
        });
      });

      document.querySelectorAll("[data-copy-template]").forEach((button) => {
        button.addEventListener("click", () => {
          const selector = button.getAttribute("data-copy-template");
          const node = selector ? document.querySelector(selector) : null;
          const text = node?.innerText;
          if (text) {
            navigator.clipboard?.writeText(text.trim());
            notifyCopy(button);
          }
        });
      });
    })();
  </script>
{% endblock %}
