{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Аренды</h1>
      <p class="text-muted small mb-0">Гибкий поиск по договорам, клиентам, авто и датам.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <a href="{% url 'rentals:import_rentals_csv' %}" class="btn btn-outline-secondary">Импорт таблицы</a>
      <a href="{% url 'rentals:export_rentals_csv' %}" class="btn btn-outline-secondary">Экспорт таблицы</a>
      <a href="{% url 'rentals:rental_wizard' %}" class="btn btn-outline-primary">Мастер договора</a>
      <a href="{% url 'rentals:rental_create' %}" class="btn btn-primary">Создать аренду</a>
    </div>
  </div>

  <form method="get" class="row g-2 align-items-end mb-3" role="search">
    <div class="col-lg-6">
      <label class="form-label" for="rentalSearchInput">Поиск по сделкам</label>
      <div class="input-group">
        <span class="input-group-text text-muted">Поиск</span>
        <input
          type="search"
          class="form-control"
          id="rentalSearchInput"
          name="q"
          value="{{ search_query }}"
          placeholder="Номер договора, фамилия, авто, ВИН/СТС, дата начала"
          autocomplete="off"
        >
      </div>
      <div class="form-text text-muted">
        Ищет по номеру договора, фамилии/телефону клиента, номеру/марке авто, ВИН/СТС и датам (ДД-ММ-ГГГГ).
        Работает на лету и по кнопке поиска.
      </div>
    </div>
    <div class="col-lg-3 col-md-6">
      <label class="form-label" for="rentalStatusFilter">Статус</label>
      <select name="status" id="rentalStatusFilter" class="form-select">
        <option value="">Любой статус</option>
        {% for code, label in rental_status_choices %}
          <option value="{{ code }}" {% if status_filter == code %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-lg-3 col-md-6 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Найти</button>
      {% if filters_active %}
        <a class="btn btn-outline-secondary" href="{% url 'rentals:rental_list' %}">Сбросить</a>
      {% endif %}
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Сделка</th>
            <th>Клиент</th>
            <th>Авто</th>
            <th>Даты</th>
            <th>Итого</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for rental in object_list %}
            <tr
              data-search-text="
                {{ rental.deal_name }}
                {{ rental.customer.full_name }} {{ rental.customer.phone }} {{ rental.customer.email }} {{ rental.customer.license_number }}
                {{ rental.second_driver.full_name }} {{ rental.second_driver.phone }} {{ rental.second_driver.email }} {{ rental.second_driver.license_number }}
                {{ rental.car.plate_number }} {{ rental.car.make }} {{ rental.car.model }} {{ rental.car.vin }} {{ rental.car.sts_number }}
                {{ rental.start_date|date:'d-m-Y' }} {{ rental.end_date|date:'d-m-Y' }} {{ rental.get_status_display }}
              "
              data-status="{{ rental.status }}"
            >
              <td>
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div>
                    <div class="fw-semibold">{{ rental.deal_name }}</div>
                    <div class="text-muted small">
                      Номер договора: {{ rental.contract_number }}<br>
                      С {{ rental.start_date|date:"d-m-Y" }} по {{ rental.end_date|date:"d-m-Y" }}
                    </div>
                  </div>
                  {% if rental.status == "active" %}
                    <span class="badge text-bg-success">{{ rental.get_status_display }}</span>
                  {% elif rental.status == "completed" %}
                    <span class="badge text-bg-primary">{{ rental.get_status_display }}</span>
                  {% elif rental.status == "cancelled" %}
                    <span class="badge text-bg-danger">{{ rental.get_status_display }}</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ rental.get_status_display }}</span>
                  {% endif %}
                </div>
              </td>
              <td>
                <div class="fw-semibold">{{ rental.customer.full_name }}</div>
                <div class="text-muted small">
                  {{ rental.customer.phone|default:"—" }}
                  {% if rental.customer.license_number %} · {{ rental.customer.license_number }}{% endif %}
                </div>
                {% if rental.second_driver %}
                  <div class="text-muted small">
                    2-й водитель: {{ rental.second_driver.full_name }}
                    {% if rental.second_driver.phone %} · {{ rental.second_driver.phone }}{% endif %}
                  </div>
                {% endif %}
              </td>
              <td>
                <div class="fw-semibold">{{ rental.car.plate_number }}</div>
                <div class="text-muted small">{{ rental.car.make }} {{ rental.car.model }}</div>
                <div class="text-muted small">
                  ВИН: {{ rental.car.vin|default:"—" }}{% if rental.car.sts_number %} · СТС {{ rental.car.sts_number }}{% endif %}
                </div>
              </td>
              <td>
                <div class="fw-semibold">{{ rental.start_date|date:"d-m-Y" }}</div>
                <div class="text-muted small">до {{ rental.end_date|date:"d-m-Y" }}</div>
              </td>
              <td>
                <div class="fw-semibold">₽{{ rental.total_price }}</div>
                <div class="text-muted small">{{ rental.daily_rate }} в день</div>
                <div class="text-muted small">
                  Предоплата: ₽{{ rental.prepayment }} · К оплате: ₽{{ rental.balance_due }}
                </div>
              </td>
              <td class="text-end">
                <a href="{% url 'rentals:rental_update' rental.pk %}" class="btn btn-sm btn-outline-secondary">Изменить</a>
                {% if contract_templates %}
                  <div class="btn-group ms-2">
                    <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                      Договор
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                      {% for ct in contract_templates %}
                        <li>
                          <a class="dropdown-item" href="{% url 'rentals:generate_contract' rental.pk ct.pk %}">
                            {{ ct.name }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Аренд пока нет. Создайте первую сделку.</td>
            </tr>
          {% endfor %}
          <tr id="rentalNoMatchesRow" class="d-none">
            <td colspan="6" class="text-center text-muted py-4">Нет совпадений по фильтрам.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    (() => {
      const searchInput = document.getElementById("rentalSearchInput");
      const statusSelect = document.getElementById("rentalStatusFilter");
      const rows = Array.from(document.querySelectorAll("tr[data-search-text]"));
      const noMatchesRow = document.getElementById("rentalNoMatchesRow");
      const normalize = (value) => (value || "").toLowerCase();

      function applyFilter() {
        const term = normalize(searchInput?.value || "");
        const status = normalize(statusSelect?.value || "");
        let visible = 0;

        rows.forEach((row) => {
          const text = normalize(row.dataset.searchText || "");
          const rowStatus = normalize(row.dataset.status || "");
          const matchesTerm = !term || text.includes(term);
          const matchesStatus = !status || rowStatus === status;
          const show = matchesTerm && matchesStatus;
          row.classList.toggle("d-none", !show);
          if (show) visible += 1;
        });

        if (noMatchesRow) {
          noMatchesRow.classList.toggle("d-none", visible > 0);
        }
      }

      searchInput?.addEventListener("input", applyFilter);
      statusSelect?.addEventListener("change", applyFilter);
      applyFilter();
    })();
  </script>
{% endblock %}
