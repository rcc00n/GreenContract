{% extends "base.html" %}

{% block content %}
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h4 mb-0">{% if object %}Edit rental{% else %}Create rental{% endif %}</h1>
          <p class="text-muted small mb-0">Set rental dates, pricing, and status.</p>
        </div>
        <a href="{% url 'rentals:rental_list' %}" class="btn btn-outline-secondary">Back to list</a>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="row g-3">
              <div class="col-md-4 col-lg-3">
                <label class="form-label" for="{{ form.contract_number.id_for_label }}">Contract number</label>
                {{ form.contract_number }}
                <div class="form-text">
                  5-значный номер генерируется автоматически и попадёт в название сделки.
                </div>
                <div class="small text-muted" id="deal-name-preview">
                  Пример: 12345/Фамилия/A123BC Toyota/2025-01-01
                </div>
                {% for error in form.contract_number.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-8 col-lg-9">
                <div class="alert alert-light border small mb-0">
                  <div class="fw-semibold">Формат названия сделки</div>
                  <div class="text-muted">
                    {номер договора}/{Фамилия}/{Номер машины + марка}/{Дата начала аренды}.<br>
                    Фамилия берётся из клиента, авто — из гос. номера и марки, дата — из начала аренды.
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.car.id_for_label }}">Car</label>
                {{ form.car }}
                <div class="form-text">Авто из списка автоматически подтягивает цену по длительности.</div>
                {% for error in form.car.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label" for="customer-search">Customer</label>
                {{ form.customer }}
                <div class="position-relative">
                  <input
                    type="search"
                    class="form-control{% if form.customer.errors %} is-invalid{% endif %}"
                    id="customer-search"
                    placeholder="Начните вводить имя, телефон или email"
                    autocomplete="off"
                    data-search-url="{% url 'rentals:customer_search' %}"
                    data-initial-label="{{ customer_initial_label|default_if_none:'' }}"
                  >
                  <div
                    class="dropdown-menu w-100 shadow-sm"
                    id="customer-search-results"
                    aria-label="Customer search results"
                    style="max-height: 280px; overflow-y: auto;"
                  ></div>
                </div>
                <div class="form-text">
                  Поиск по имени, телефону, email или номеру удостоверения. Минимум 2 символа.
                </div>
                <div class="small text-muted mt-1" id="customer-selected-summary">
                  {% if customer_initial_label %}{{ customer_initial_label }}{% else %}Клиент не выбран{% endif %}
                </div>
                {% for error in form.customer.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <div class="fw-semibold">Данные выбранного авто</div>
                      <div class="text-muted small">VIN, СТС и год подтягиваются автоматически.</div>
                    </div>
                    <a href="#" class="btn btn-sm btn-outline-secondary d-none" id="car-edit-link" target="_blank" rel="noopener">
                      Edit car
                    </a>
                  </div>
                  <div id="car-details" class="row small gy-1">
                    <div class="col-md-4">
                      <div class="fw-semibold" data-field="plate">—</div>
                      <div class="text-muted" data-field="makeModel">—</div>
                      <div>Год: <span data-field="year">—</span></div>
                    </div>
                    <div class="col-md-4">
                      <div>VIN: <span data-field="vin">—</span></div>
                      <div>СТС: <span data-field="sts_number">—</span></div>
                    </div>
                    <div class="col-md-4">
                      <div>СТС выдана: <span data-field="sts_issue_date">—</span></div>
                      <div>Кем: <span data-field="sts_issued_by">—</span></div>
                    </div>
                  </div>
                  <div class="text-muted small" id="car-details-empty">Выберите авто, чтобы увидеть VIN и СТС.</div>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.start_date.id_for_label }}">Start date</label>
                {{ form.start_date }}
                <div class="form-text">Выберите дату начала аренды.</div>
                {% for error in form.start_date.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label" for="{{ form.end_date.id_for_label }}">End date</label>
                {{ form.end_date }}
                <div class="form-text">Система подставит цену в зависимости от количества дней.</div>
                {% for error in form.end_date.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <span class="small text-muted">Быстрый выбор длительности:</span>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="3">3 дня</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="7">7 дней</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="14">14 дней</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="30">30 дней</button>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.daily_rate.id_for_label }}">Daily rate</label>
                {{ form.daily_rate }}
                <div class="form-text">Автозаполнение по тарифу автомобиля.</div>
                {% for error in form.daily_rate.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label" for="{{ form.total_price.id_for_label }}">Total price</label>
                {{ form.total_price }}
                <div class="form-text">Считается автоматически по количеству дней.</div>
                {% for error in form.total_price.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.status.id_for_label }}">Status</label>
                {{ form.status }}
                {% for error in form.status.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
            </div>

            <div class="alert alert-info d-flex align-items-center gap-2 mt-3" id="price-summary" role="alert">
              <div class="spinner-border spinner-border-sm text-primary me-2 d-none" id="price-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <div>
                <div class="fw-semibold mb-1">Итого будет рассчитано автоматически</div>
                <div class="small text-muted" id="price-summary-text">Выберите авто и даты аренды.</div>
              </div>
            </div>

            <script>
              (function() {
                const searchInput = document.getElementById("customer-search");
                const resultsMenu = document.getElementById("customer-search-results");
                const hiddenField = document.getElementById("id_customer");
                const summary = document.getElementById("customer-selected-summary");
                const searchUrl = searchInput?.dataset.searchUrl;
                const initialLabel = searchInput?.dataset.initialLabel;
                let debounceTimer = null;
                let activeRequest = null;
                let lastSelectedLabel = initialLabel && hiddenField?.value ? initialLabel : "";

                if (!searchInput || !resultsMenu || !hiddenField || !searchUrl) {
                  return;
                }

                function setSummary(text, highlight = false) {
                  if (!summary) return;
                  summary.textContent = text;
                  summary.classList.toggle("text-danger", highlight);
                }

                function clearResults() {
                  resultsMenu.innerHTML = "";
                  resultsMenu.classList.remove("show");
                }

                function selectCustomer(item) {
                  if (!item) return;
                  hiddenField.value = item.id;
                  const parts = [item.name, item.phone].filter(Boolean);
                  const label = parts.join(" · ") || item.name;
                  searchInput.value = item.name;
                  lastSelectedLabel = label;
                  setSummary(label);
                  document.dispatchEvent(
                    new CustomEvent("rental:customer-change", { detail: { name: item.name } })
                  );
                  clearResults();
                }

                function renderResults(items) {
                  clearResults();
                  if (!items.length) {
                    const empty = document.createElement("div");
                    empty.className = "dropdown-item text-muted small";
                    empty.textContent = "Ничего не найдено";
                    resultsMenu.appendChild(empty);
                    resultsMenu.classList.add("show");
                    return;
                  }

                  items.forEach((item) => {
                    const btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "dropdown-item text-wrap";
                    btn.dataset.id = item.id;

                    btn.addEventListener("click", () => selectCustomer(item));

                    const title = document.createElement("div");
                    title.className = "fw-semibold";
                    title.textContent = item.name;

                    const meta = document.createElement("div");
                    meta.className = "small text-muted";
                    const metaParts = [item.phone, item.email, item.license_number].filter(Boolean);
                    meta.textContent = metaParts.join(" • ");

                    btn.appendChild(title);
                    btn.appendChild(meta);
                    resultsMenu.appendChild(btn);
                  });

                  resultsMenu.classList.add("show");
                }

                function fetchResults(term) {
                  if (!term) return;

                  if (activeRequest) {
                    activeRequest.abort();
                  }

                  const controller = new AbortController();
                  activeRequest = controller;

                  resultsMenu.innerHTML = '<span class="dropdown-item text-muted small">Ищем...</span>';
                  resultsMenu.classList.add("show");

                  fetch(`${searchUrl}?q=${encodeURIComponent(term)}`, { signal: controller.signal })
                    .then((response) => (response.ok ? response.json() : Promise.reject()))
                    .then((data) => {
                      if (controller.signal.aborted) return;
                      renderResults((data && data.results) || []);
                    })
                    .catch(() => {
                      if (controller.signal.aborted) return;
                      clearResults();
                      setSummary("Не удалось загрузить клиентов. Попробуйте ещё раз.", true);
                    })
                    .finally(() => {
                      if (activeRequest === controller) {
                        activeRequest = null;
                      }
                    });
                }

                function handleInput() {
                  const term = searchInput.value.trim();
                  if (term !== lastSelectedLabel && hiddenField.value) {
                    hiddenField.value = "";
                  }

                  if (term.length < 2) {
                    clearResults();
                    if (!hiddenField.value) {
                      setSummary("Введите минимум 2 символа для поиска.", true);
                    }
                    return;
                  }

                  setSummary("Выберите клиента из результатов поиска.");

                  if (debounceTimer) {
                    window.clearTimeout(debounceTimer);
                  }
                  debounceTimer = window.setTimeout(() => fetchResults(term), 180);
                }

                searchInput.addEventListener("input", handleInput);
                searchInput.addEventListener("focus", () => {
                  if (resultsMenu.innerHTML.trim()) {
                    resultsMenu.classList.add("show");
                  }
                });

                document.addEventListener("click", (event) => {
                  if (event.target === searchInput || resultsMenu.contains(event.target)) {
                    return;
                  }
                  clearResults();
                });

                if (initialLabel && hiddenField.value) {
                  searchInput.value = initialLabel;
                  setSummary(initialLabel);
                  document.dispatchEvent(
                    new CustomEvent("rental:customer-change", { detail: { name: searchInput.value || initialLabel } })
                  );
                } else if (hiddenField.value) {
                  setSummary("Клиент выбран");
                } else {
                  setSummary("Введите минимум 2 символа для поиска.", true);
                }
              })();
            </script>

            {% if car_pricing %}
              {{ car_pricing|json_script:"car-pricing-data" }}
            {% endif %}

            <script>
              (function() {
                const carSelect = document.getElementById("id_car");
                const startInput = document.getElementById("id_start_date");
                const endInput = document.getElementById("id_end_date");
                const dailyRateInput = document.getElementById("id_daily_rate");
                const totalInput = document.getElementById("id_total_price");
                const summaryText = document.getElementById("price-summary-text");
                const quickButtons = document.querySelectorAll("button[data-days]");
                const contractInput = document.getElementById("id_contract_number");
                const dealPreview = document.getElementById("deal-name-preview");
                const carDetails = document.getElementById("car-details");
                const carDetailsEmpty = document.getElementById("car-details-empty");
                const carEditLink = document.getElementById("car-edit-link");
                const customerSearchInput = document.getElementById("customer-search");
                let selectedCustomerName = (customerSearchInput?.value || "").trim();
                let currentCar = null;
                const carPricingData = window.JSON.parse(
                  (document.getElementById("car-pricing-data") || { textContent: "[]" }).textContent
                );

                const msPerDay = 24 * 60 * 60 * 1000;

                function parseDate(value) {
                  if (!value) return null;
                  const parts = value.split("-");
                  if (parts.length !== 3) return null;
                  const [year, month, day] = parts.map((p) => parseInt(p, 10));
                  if (!year || !month || !day) return null;
                  return new Date(Date.UTC(year, month - 1, day));
                }

                function diffDays(start, end) {
                  if (!start || !end) return 0;
                  const diff = Math.round((end - start) / msPerDay);
                  return diff > 0 ? diff : 0;
                }

                function pickRate(car, days) {
                  if (!car) return 0;
                  const tiers = [
                    { threshold: 15, high: "rate_15_plus_high", low: "rate_15_plus_low" },
                    { threshold: 5, high: "rate_5_14_high", low: "rate_5_14_low" },
                    { threshold: 1, high: "rate_1_4_high", low: "rate_1_4_low" },
                  ];

                  for (const tier of tiers) {
                    if (days >= tier.threshold) {
                      if (car[tier.high]) return car[tier.high];
                      if (car[tier.low]) return car[tier.low];
                    }
                  }
                  return car.daily_rate || 0;
                }

                function formatMoney(value) {
                  return new Intl.NumberFormat("ru-RU", { style: "currency", currency: "RUB" }).format(value || 0);
                }

                function setCarDetail(field, value) {
                  const el = carDetails?.querySelector(`[data-field="${field}"]`);
                  if (el) {
                    el.textContent = value || "—";
                  }
                }

                function updateCarDetails(car) {
                  if (!carDetails || !carDetailsEmpty) return;
                  if (!car) {
                    setCarDetail("plate", "—");
                    setCarDetail("makeModel", "—");
                    setCarDetail("year", "—");
                    setCarDetail("vin", "—");
                    setCarDetail("sts_number", "—");
                    setCarDetail("sts_issue_date", "—");
                    setCarDetail("sts_issued_by", "—");
                    carDetailsEmpty.classList.remove("d-none");
                    carDetails.classList.add("opacity-50");
                    carEditLink?.classList.add("d-none");
                    return;
                  }

                  setCarDetail("plate", car.plate_number || "—");
                  setCarDetail("makeModel", [car.make, car.model].filter(Boolean).join(" ").trim() || "—");
                  setCarDetail("year", car.year || "—");
                  setCarDetail("vin", car.vin || "—");
                  setCarDetail("sts_number", car.sts_number || "—");
                  setCarDetail("sts_issue_date", car.sts_issue_date || "—");
                  setCarDetail("sts_issued_by", car.sts_issued_by || "—");
                  carDetailsEmpty.classList.add("d-none");
                  carDetails.classList.remove("opacity-50");
                  if (carEditLink) {
                    if (car.edit_url) {
                      carEditLink.href = car.edit_url;
                      carEditLink.classList.remove("d-none");
                    } else {
                      carEditLink.classList.add("d-none");
                    }
                  }
                }

                function extractLastName(name) {
                  const parts = (name || "").trim().split(/\s+/);
                  return parts.length ? parts[0] : "";
                }

                function updateDealPreview(car) {
                  if (!dealPreview) return;
                  const contract = (contractInput?.value || "").trim() || "#####";
                  const lastName = extractLastName(selectedCustomerName) || "Фамилия";
                  const carPart = car ? `${car.plate_number} ${car.make}`.trim() : "Авто";
                  const datePart = startInput?.value || "дата";
                  dealPreview.textContent = `${contract}/${lastName}/${carPart}/${datePart}`;
                }

                const initialValues = {
                  car: carSelect ? carSelect.value : "",
                  start: startInput ? startInput.value : "",
                  end: endInput ? endInput.value : "",
                  daily: dailyRateInput ? dailyRateInput.value : "",
                  total: totalInput ? totalInput.value : "",
                };

                function updatePricing(forceWrite = false) {
                  const carId = Number(carSelect?.value);
                  currentCar = carPricingData.find((item) => item.id === carId);
                  const startDate = parseDate(startInput?.value);
                  const endDate = parseDate(endInput?.value);
                  const days = diffDays(startDate, endDate);
                  const hasExistingPrice = Boolean((dailyRateInput && dailyRateInput.value) || (totalInput && totalInput.value));
                  const inputsChanged =
                    initialValues.car !== (carSelect ? carSelect.value : "") ||
                    initialValues.start !== (startInput ? startInput.value : "") ||
                    initialValues.end !== (endInput ? endInput.value : "");
                  const shouldWrite = forceWrite || !hasExistingPrice || inputsChanged;

                  updateCarDetails(currentCar);
                  updateDealPreview(currentCar);

                  if (!currentCar || !days) {
                    if (shouldWrite && dailyRateInput) dailyRateInput.value = "";
                    if (shouldWrite && totalInput) totalInput.value = "";
                    if (hasExistingPrice && !shouldWrite) {
                      summaryText.textContent = `Сохранённая сумма: ${formatMoney(Number(totalInput?.value || 0))}`;
                    } else {
                      summaryText.textContent = "Выберите авто и корректные даты аренды.";
                    }
                    return;
                  }

                  if (!shouldWrite && hasExistingPrice && days > 0) {
                    summaryText.textContent = `${days} дн × ${formatMoney(Number(dailyRateInput?.value || 0))} = ${formatMoney(Number(totalInput?.value || 0))}`;
                    return;
                  }

                  const rate = pickRate(currentCar, days);
                  const total = rate * days;

                  if (shouldWrite && dailyRateInput) dailyRateInput.value = rate ? rate.toFixed(2) : "";
                  if (shouldWrite && totalInput) totalInput.value = total ? total.toFixed(2) : "";

                  summaryText.textContent = `${days} дн × ${formatMoney(rate)} = ${formatMoney(total)}`;
                }

                quickButtons.forEach((btn) => {
                  btn.addEventListener("click", () => {
                    const days = Number(btn.getAttribute("data-days") || "0");
                    const startDate = parseDate(startInput?.value) || new Date();
                    const endDate = new Date(startDate.getTime() + days * msPerDay);
                    const format = (date) => {
                      const y = date.getUTCFullYear();
                      const m = String(date.getUTCMonth() + 1).padStart(2, "0");
                      const d = String(date.getUTCDate()).padStart(2, "0");
                      return `${y}-${m}-${d}`;
                    };
                    if (startInput && !startInput.value) {
                      startInput.value = format(startDate);
                    }
                    if (endInput) {
                      endInput.value = format(endDate);
                    }
                    updatePricing(true);
                  });
                });

                [carSelect, startInput, endInput].forEach((el) => {
                  if (el) {
                    el.addEventListener("change", () => updatePricing(true));
                    el.addEventListener("input", () => updatePricing(true));
                  }
                });

                customerSearchInput?.addEventListener("input", () => {
                  selectedCustomerName = customerSearchInput.value.trim();
                  updateDealPreview(currentCar);
                });

                document.addEventListener("rental:customer-change", (event) => {
                  selectedCustomerName = (event.detail?.name || "").trim();
                  updateDealPreview(currentCar);
                });

                contractInput?.addEventListener("input", () => updateDealPreview(currentCar));

                updatePricing(false);
              })();
            </script>

            <div class="d-flex justify-content-end gap-2 pt-3">
              <a href="{% url 'rentals:rental_list' %}" class="btn btn-outline-secondary">Cancel</a>
              <button class="btn btn-primary" type="submit">Save rental</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
