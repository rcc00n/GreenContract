{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Клиенты</h1>
      <p class="text-muted small mb-0">Карточки водителей с контактами, документами, стажем и тегами.</p>
    </div>
    <div class="d-flex flex-wrap gap-2">
      <form method="post" action="{% url 'rentals:customer_delete_all' %}" class="d-inline">
        {% csrf_token %}
        <button
          type="submit"
          class="btn btn-outline-danger"
          onclick="return confirm('Удалить всех клиентов без аренды?');"
        >
          Удалить без аренды
        </button>
      </form>
      <a href="{% url 'rentals:import_customers_csv' %}" class="btn btn-outline-secondary">Импорт таблицы</a>
      <a href="{% url 'rentals:export_customers_csv' %}" class="btn btn-outline-secondary">Экспорт таблицы</a>
      <a href="{% url 'rentals:customer_create' %}" class="btn btn-primary">Добавить клиента</a>
    </div>
  </div>

  <form method="get" id="customerFilterForm" class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-lg-6">
          <label class="form-label fw-semibold" for="customerSearchInput">Поиск</label>
          <div class="input-group">
            <span class="input-group-text text-muted">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="7"></circle>
                <path d="m16.5 16.5 3.5 3.5"></path>
              </svg>
            </span>
            <input
              type="search"
              class="form-control"
              id="customerSearchInput"
              name="q"
              value="{{ search_query }}"
              placeholder="ФИО, телефон, эл. почта, ВУ, паспорт, адрес прописки или тег"
              autocomplete="off"
            >
            <input type="hidden" name="page" value="1">
            <input type="hidden" name="page_size" value="{{ current_page_size }}">
          </div>
          <div class="form-text text-muted small">
            Поиск сразу по нескольким атрибутам: ФИО, телефон, эл. почта, номер ВУ, паспорт, адрес прописки, стаж, теги.
            Вводите несколько слов — фильтр применится автоматически.
          </div>
        </div>
        <div class="col-lg-6">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-1">
            <label class="form-label fw-semibold mb-0" for="tagToggleButton">Теги</label>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary d-none"
              id="tagToggleButton"
              aria-expanded="false"
              aria-controls="tagFilterList"
            >
              Показать все теги
            </button>
          </div>
          <div class="tag-filter" id="tagFilterContainer">
            <div class="tag-filter-list d-flex flex-wrap gap-2" id="tagFilterList">
              {% for tag in available_tags %}
                <div class="form-check form-check-inline">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="tag"
                    id="tag-{{ tag.id }}"
                    value="{{ tag.id }}"
                    {% if tag.id in active_tags %}checked{% endif %}
                  >
                  <label class="form-check-label" for="tag-{{ tag.id }}">{{ tag.name }}</label>
                </div>
              {% empty %}
                <div class="text-muted small">Добавьте теги в карточке клиента, чтобы строить выборки.</div>
              {% endfor %}
            </div>
            <div class="tag-filter-fade" aria-hidden="true"></div>
          </div>
        </div>
      </div>
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mt-3">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label fw-semibold mb-0" for="customerSortSelect">Сортировка</label>
          <select
            name="sort"
            id="customerSortSelect"
            class="form-select form-select-sm"
            onchange="this.form.submit()"
          >
            {% for value, label in sort_options %}
              <option value="{{ value }}" {% if value == active_sort %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="d-flex gap-2">
          {% if filters_active %}
            <a class="btn btn-outline-secondary" href="{% url 'rentals:customer_list' %}">Сбросить</a>
          {% endif %}
          <button class="btn btn-primary" type="submit">Применить</button>
        </div>
      </div>
    </div>
  </form>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-muted small" style="width: 70px;">#</th>
            <th>Клиент</th>
            <th>Контакты</th>
            <th>Документы и стаж</th>
            <th>Адрес прописки</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for customer in object_list %}
            {% with tags=customer.tags.all %}
            <tr data-search-text="
                {{ customer.full_name }}
                {{ customer.phone }}
                {{ customer.email }}
                {{ customer.license_number }} {{ customer.license_issued_by }}
                {{ customer.passport_series }} {{ customer.passport_number }}
                {{ customer.passport_issued_by }}
                {{ customer.registration_address }}
                {{ customer.birth_date|date:"d-m-Y" }}
                {{ customer.driving_since|date:"d-m-Y" }}
                {{ customer.discount_percent }}
                {% for tag in tags %}{{ tag.name }} {% endfor %}
              ">
              {% if page_obj %}
                {% with row_number=page_obj.start_index|add:forloop.counter0 %}
                  <td class="text-muted small">{{ row_number }}</td>
                {% endwith %}
            {% else %}
              <td class="text-muted small">{{ forloop.counter }}</td>
            {% endif %}
            <td>
              <div class="fw-semibold">{{ customer.full_name }}</div>
              {% if customer.birth_date %}<div class="text-muted small">Дата рождения: {{ customer.birth_date|date:"d-m-Y" }}</div>{% endif %}
              {% if customer.discount_percent is not None %}
                <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle mt-1">
                  Скидка {{ customer.discount_percent|floatformat:"-2" }}%
                </span>
              {% endif %}
              {% if tags %}
                <div class="d-flex flex-wrap gap-1 mt-1">
                  {% for tag in tags %}
                    <span class="badge rounded-pill bg-success-subtle text-success-emphasis border border-success-subtle">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </td>
            <td>
              <div class="fw-semibold">{{ customer.phone|default:"—" }}</div>
              <div class="text-muted small">{{ customer.email|default:"—" }}</div>
            </td>
            <td class="small">
              <div class="fw-semibold">
                Паспорт:
                {% if customer.passport_series or customer.passport_number %}
                  {{ customer.passport_series|default:"" }} {{ customer.passport_number|default:"" }}
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="text-muted">
                {% if customer.passport_issued_by or customer.passport_issue_date %}
                  {{ customer.passport_issued_by|default:"Кем выдан не заполнено" }}
                  {% if customer.passport_issue_date %} · {{ customer.passport_issue_date|date:"d-m-Y" }}{% endif %}
                {% else %}
                  Данные о выдаче не заполнены
                {% endif %}
              </div>
              <div class="fw-semibold mt-2">
                Вод. удостоверение:
                {% if customer.license_number %}
                  {{ customer.license_number }}
                {% else %}
                  —
                {% endif %}
              </div>
              <div class="text-muted">
                {% if customer.license_issued_by %}Выдано: {{ customer.license_issued_by }}{% endif %}
                {% if customer.driving_since %}
                  {% if customer.license_issued_by %} · {% endif %}
                  Стаж с {{ customer.driving_since|date:"d-m-Y" }}
                {% endif %}
                {% if not customer.license_issued_by and not customer.driving_since %}
                  —
                {% endif %}
              </div>
            </td>
            <td class="small text-muted">
                {% if customer.registration_address %}<div>Адрес прописки: {{ customer.registration_address|truncatechars:90 }}</div>{% endif %}
                {% if not customer.registration_address %}
                  <div>—</div>
                {% endif %}
            </td>
            <td class="text-end">
              <div class="d-inline-flex gap-2 justify-content-end">
                  <a href="{% url 'rentals:customer_update' customer.pk %}" class="btn btn-sm btn-outline-secondary">Изменить</a>
                  <form method="post" action="{% url 'rentals:customer_delete' customer.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Удалить {{ customer.full_name }}?');"
                    >
                      Удалить
                    </button>
                  </form>
              </div>
            </td>
          </tr>
            {% endwith %}
          {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                {% if filters_active %}
                  Нет клиентов по текущим фильтрам.
                {% else %}
                  Клиентов пока нет. Добавьте первую карточку водителя.
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if page_obj %}
      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between p-3 border-top pagination-bar">
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted small">Строк на странице</span>
          <form method="get" class="d-flex align-items-center gap-2">
            <input type="hidden" name="page" value="1">
            {% if search_query %}
              <input type="hidden" name="q" value="{{ search_query }}">
            {% endif %}
            {% if active_sort and active_sort != default_sort %}
              <input type="hidden" name="sort" value="{{ active_sort }}">
            {% endif %}
            {% for tag_id in active_tags %}
              <input type="hidden" name="tag" value="{{ tag_id }}">
            {% endfor %}
            <select name="page_size" class="form-select form-select-sm" onchange="this.form.submit()">
              {% for size in page_size_options %}
                <option value="{{ size }}" {% if size == current_page_size %}selected{% endif %}>{{ size }}</option>
              {% endfor %}
            </select>
          </form>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3">
          <span class="text-muted small">
            Показано {{ page_obj.start_index }}-{{ page_obj.end_index }} из {{ page_obj.paginator.count }}
          </span>
          {% with page_size=page_obj.paginator.per_page %}
            <nav aria-label="Навигация по страницам клиентов">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                  {% if page_obj.has_previous %}
                    <a class="page-link" href="?page=1&page_size={{ page_size }}{{ querystring }}" aria-label="Первая страница">&laquo;</a>
                  {% else %}
                    <span class="page-link">&laquo;</span>
                  {% endif %}
                </li>
                <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                  {% if page_obj.has_previous %}
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}{{ querystring }}" aria-label="Предыдущая страница">&lsaquo;</a>
                  {% else %}
                    <span class="page-link">&lsaquo;</span>
                  {% endif %}
                </li>
                <li class="page-item disabled">
                  <span class="page-link text-muted">Страница {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</span>
                </li>
                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                  {% if page_obj.has_next %}
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}{{ querystring }}" aria-label="Следующая страница">&rsaquo;</a>
                  {% else %}
                    <span class="page-link">&rsaquo;</span>
                  {% endif %}
                </li>
                <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                  {% if page_obj.has_next %}
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&page_size={{ page_size }}{{ querystring }}" aria-label="Последняя страница">&raquo;</a>
                  {% else %}
                    <span class="page-link">&raquo;</span>
                  {% endif %}
                </li>
              </ul>
            </nav>
          {% endwith %}
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    (() => {
      const form = document.getElementById("customerFilterForm");
      const searchInput = document.getElementById("customerSearchInput");
      const tagInputs = form ? Array.from(form.querySelectorAll("input[name='tag']")) : [];
      const tagFilterContainer = document.getElementById("tagFilterContainer");
      const tagFilterList = document.getElementById("tagFilterList");
      const tagToggleButton = document.getElementById("tagToggleButton");
      const collapseHeight = tagFilterContainer
        ? parseFloat(getComputedStyle(tagFilterContainer).getPropertyValue("--tag-collapse-height")) || 132
        : 132;
      let timer = null;
      let resizeTimer = null;

      const submitForm = () => {
        if (!form) return;
        form.requestSubmit ? form.requestSubmit() : form.submit();
      };

      searchInput?.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(submitForm, 400);
      });

      tagInputs.forEach((checkbox) => {
        checkbox.addEventListener("change", () => {
          submitForm();
        });
      });

      const updateTagOverflowState = () => {
        if (!tagFilterContainer || !tagFilterList || !tagToggleButton) return;
        const hasOverflow = tagFilterList.scrollHeight - collapseHeight > 6;

        tagFilterContainer.classList.toggle("tag-filter-overflow", hasOverflow);
        tagToggleButton.classList.toggle("d-none", !hasOverflow);

        if (!hasOverflow) {
          tagFilterContainer.classList.remove("is-expanded");
          tagToggleButton.setAttribute("aria-expanded", "false");
          tagToggleButton.textContent = "Показать все теги";
        }
      };

      tagToggleButton?.addEventListener("click", () => {
        if (!tagFilterContainer) return;
        const expanded = tagFilterContainer.classList.toggle("is-expanded");
        tagToggleButton.setAttribute("aria-expanded", expanded ? "true" : "false");
        tagToggleButton.textContent = expanded ? "Скрыть теги" : "Показать все теги";
      });

      if (tagFilterContainer && tagFilterList) {
        updateTagOverflowState();
        window.addEventListener("resize", () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(updateTagOverflowState, 150);
        });
        window.addEventListener("load", updateTagOverflowState);
      }
    })();
  </script>
{% endblock %}
