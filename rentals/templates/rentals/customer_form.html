{% extends "base.html" %}

{% block content %}
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h1 class="h4 mb-0">{% if object %}Редактирование клиента{% else %}Новый клиент{% endif %}</h1>
          <p class="text-muted small mb-0">Контакты, документы, стаж и скидка.</p>
        </div>
        <a href="{% url 'rentals:customer_list' %}" class="btn btn-outline-secondary">Назад к списку</a>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" novalidate>
            {% csrf_token %}
            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="border rounded p-3 mb-3 bg-light">
              <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                  <div class="fw-semibold">Сканирование водительского удостоверения</div>
                  <div class="text-muted small">Загрузите фото лицевой и обратной сторон, чтобы быстро заполнить поля.</div>
                  <div class="text-muted small">Совет: снимайте при хорошем освещении без бликов, держите текст в фокусе и заполняйте кадр.</div>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="ocr-replace-existing">
                  <label class="form-check-label small" for="ocr-replace-existing">Заменять заполненные поля</label>
                </div>
              </div>
              <div class="row g-3 mt-1">
                <div class="col-md-6">
                  <label class="form-label" for="ocr-front-image">Лицевая сторона</label>
                  <input type="file" class="form-control" id="ocr-front-image" accept="image/*">
                  <input type="file" class="d-none" id="ocr-front-camera" accept="image/*" capture="environment">
                  <div class="d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-ocr-camera="front">Использовать камеру</button>
                  </div>
                </div>
                <div class="col-md-6">
                  <label class="form-label" for="ocr-back-image">Обратная сторона</label>
                  <input type="file" class="form-control" id="ocr-back-image" accept="image/*">
                  <input type="file" class="d-none" id="ocr-back-camera" accept="image/*" capture="environment">
                  <div class="d-flex gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-ocr-camera="back">Использовать камеру</button>
                  </div>
                </div>
                <div class="col-12 d-flex flex-wrap align-items-center gap-2">
                  <button type="button" class="btn btn-outline-primary" id="ocr-extract-btn">Извлечь данные</button>
                  <span class="text-muted small" id="ocr-status"></span>
                </div>
                <div class="col-12 d-none" id="ocr-warnings"></div>
                <div class="col-12 d-none" id="ocr-preview"></div>
              </div>
            </div>
            <div class="row g-3">
              {% for field in form %}
                <div class="{% if field.name == 'registration_address' or field.name == 'tags_text' %}col-12{% else %}col-md-6{% endif %}">
                  <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                  {{ field }}
                  {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                  {% endif %}
                  {% for error in field.errors %}
                    <div class="invalid-feedback d-block">{{ error }}</div>
                  {% endfor %}
                </div>
              {% endfor %}
            </div>
            <div class="d-flex justify-content-end gap-2 pt-3">
              <a href="{% url 'rentals:customer_list' %}" class="btn btn-outline-secondary">Отмена</a>
              <button class="btn btn-primary" type="submit">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    .ocr-low-confidence {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
    }
    .ocr-verify-badge {
      margin-left: 6px;
      padding: 0.15rem 0.4rem;
      border-radius: 10px;
      background: #fff3cd;
      color: #664d03;
      font-size: 0.7rem;
      font-weight: 600;
    }
    #ocr-warnings {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
      color: #664d03;
    }
    #ocr-preview {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 0.5rem;
      padding: 0.75rem 1rem;
    }
  </style>

  <script>
    (function () {
      const ocrUrl = "{% url 'rentals:ocr_driver_license' %}";
      const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
      const frontInput = document.getElementById("ocr-front-image");
      const backInput = document.getElementById("ocr-back-image");
      const frontCameraInput = document.getElementById("ocr-front-camera");
      const backCameraInput = document.getElementById("ocr-back-camera");
      const statusEl = document.getElementById("ocr-status");
      const warningsEl = document.getElementById("ocr-warnings");
      const previewEl = document.getElementById("ocr-preview");
      const replaceToggle = document.getElementById("ocr-replace-existing");
      const extractButton = document.getElementById("ocr-extract-btn");
      const lowConfidenceThreshold = 0.75;

      const fieldMap = {
        full_name: "id_full_name",
        birth_date: "id_birth_date",
        license_number: "id_license_number",
        license_issued_by: "id_license_issued_by",
        driving_since: "id_driving_since",
      };

      function setStatus(text, isError) {
        if (!statusEl) return;
        statusEl.textContent = text || "";
        statusEl.classList.toggle("text-danger", Boolean(isError));
      }

      function showWarnings(warnings) {
        if (!warningsEl) return;
        if (!warnings || warnings.length === 0) {
          warningsEl.classList.add("d-none");
          warningsEl.textContent = "";
          return;
        }
        warningsEl.classList.remove("d-none");
        warningsEl.textContent = warnings.join(" ");
      }

      function showPreview(fields) {
        if (!previewEl) return;
        const categories = fields?.categories?.value || [];
        const specialMarks = fields?.special_marks?.value || "";
        if (!categories.length && !specialMarks) {
          previewEl.classList.add("d-none");
          previewEl.textContent = "";
          return;
        }
        previewEl.classList.remove("d-none");
        previewEl.innerHTML = `
          <div class="fw-semibold small mb-1">Дополнительно</div>
          <div class="small text-muted">Категории: ${categories.join(", ") || "—"}</div>
          <div class="small text-muted">Особые отметки: ${specialMarks || "—"}</div>
        `;
      }

      function normalizeDate(value) {
        const match = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(value || "");
        if (!match) return value;
        return `${match[3]}-${match[2]}-${match[1]}`;
      }

      function clearConfidenceMarkers() {
        Object.values(fieldMap).forEach((fieldId) => {
          const input = document.getElementById(fieldId);
          if (!input) return;
          input.classList.remove("ocr-low-confidence");
          const label = document.querySelector(`label[for='${fieldId}']`);
          label?.querySelector(".ocr-verify-badge")?.remove();
        });
      }

      function markLowConfidence(fieldId) {
        const input = document.getElementById(fieldId);
        if (!input) return;
        input.classList.add("ocr-low-confidence");
        const label = document.querySelector(`label[for='${fieldId}']`);
        if (label && !label.querySelector(".ocr-verify-badge")) {
          const badge = document.createElement("span");
          badge.className = "ocr-verify-badge";
          badge.textContent = "Проверьте";
          label.appendChild(badge);
        }
      }

      function shouldFill(input) {
        if (!input) return false;
        if (replaceToggle?.checked) return true;
        return !input.value;
      }

      function applyFields(fields) {
        clearConfidenceMarkers();
        Object.entries(fieldMap).forEach(([fieldName, fieldId]) => {
          const input = document.getElementById(fieldId);
          const payload = fields?.[fieldName];
          if (!input || !payload) return;
          const value = payload.value;
          if (!value && value !== 0) return;
          if (!shouldFill(input)) return;
          const formatted = fieldName.includes("date") ? normalizeDate(value) : value;
          input.value = formatted;
          if ((payload.confidence || 0) < lowConfidenceThreshold) {
            markLowConfidence(fieldId);
          }
        });
      }

      function pickFileFromCamera(role) {
        if (role === "front") frontCameraInput?.click();
        if (role === "back") backCameraInput?.click();
      }

      document.querySelectorAll("[data-ocr-camera]").forEach((button) => {
        button.addEventListener("click", () => pickFileFromCamera(button.dataset.ocrCamera));
      });

      function syncCameraToInput(cameraInput, targetInput) {
        cameraInput?.addEventListener("change", () => {
          if (!cameraInput.files || cameraInput.files.length === 0) return;
          const file = cameraInput.files[0];
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          targetInput.files = dataTransfer.files;
        });
      }

      syncCameraToInput(frontCameraInput, frontInput);
      syncCameraToInput(backCameraInput, backInput);

      extractButton?.addEventListener("click", async () => {
        const frontFile = frontInput?.files?.[0] || null;
        const backFile = backInput?.files?.[0] || null;
        if (!frontFile && !backFile) {
          setStatus("Добавьте фото лицевой и/или обратной стороны.", true);
          showWarnings([]);
          showPreview(null);
          return;
        }
        setStatus("Распознавание...", false);
        showWarnings([]);
        showPreview(null);
        const formData = new FormData();
        if (frontFile) formData.append("front_image", frontFile);
        if (backFile) formData.append("back_image", backFile);
        formData.append("source", "upload");
        try {
          const response = await fetch(ocrUrl, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            body: formData,
            credentials: "same-origin",
          });
          const payload = await response.json();
          if (payload.status === "failed") {
            setStatus("Не удалось распознать данные.", true);
          } else {
            setStatus(payload.status === "partial" ? "Часть данных распознана." : "Данные распознаны.");
          }
          showWarnings(payload.warnings || []);
          applyFields(payload.fields || {});
          showPreview(payload.fields || {});
        } catch (error) {
          setStatus("Ошибка запроса OCR.", true);
        }
      });
    })();
  </script>
{% endblock %}
