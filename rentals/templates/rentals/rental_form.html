{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">{% if object %}Edit rental{% else %}Create rental{% endif %}</h1>
      <p class="text-muted small mb-0">Set rental dates, pricing, and status.</p>
    </div>
    <a href="{% url 'rentals:rental_list' %}" class="btn btn-outline-secondary">Back to list</a>
  </div>

  <form method="post" novalidate>
    {% csrf_token %}
    <div class="row g-4 align-items-start">
      <div class="col-lg-9">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            {% if form.non_field_errors %}
              <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}
            <div class="row g-3">
              <div class="col-md-4 col-lg-3">
                <label class="form-label" for="{{ form.contract_number.id_for_label }}">Contract number</label>
                {{ form.contract_number }}
                {% for error in form.contract_number.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-md-6">
                <label class="form-label" for="{{ form.car.id_for_label }}">Car</label>
                {{ form.car }}
                <div class="form-text">Авто из списка автоматически подтягивает цену по длительности.</div>
                {% for error in form.car.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-md-6">
                <label class="form-label" for="customer-search">Customer</label>
                {{ form.customer }}
                <div class="d-flex align-items-start gap-2">
                  <div class="flex-grow-1 position-relative">
                    <input
                      type="search"
                      class="form-control{% if form.customer.errors %} is-invalid{% endif %}"
                      id="customer-search"
                      placeholder="Начните вводить имя, телефон или email"
                      autocomplete="off"
                      data-search-url="{% url 'rentals:customer_search' %}"
                      data-initial-label="{{ customer_initial_label|default_if_none:'' }}"
                    >
                    <div
                      class="dropdown-menu w-100 shadow-sm"
                      id="customer-search-results"
                      aria-label="Customer search results"
                      style="max-height: 280px; overflow-y: auto;"
                    ></div>
                  </div>
                  <a
                    href="#"
                    class="btn btn-sm btn-outline-secondary align-self-start disabled"
                    id="customer-edit-link"
                    data-edit-url-template="{% url 'rentals:customer_update' 0 %}"
                    target="_blank"
                    rel="noopener"
                    aria-disabled="true"
                    tabindex="-1"
                  >
                    Редактировать клиента
                  </a>
                </div>
                <div class="form-text">
                  Поиск по имени, телефону, email или номеру удостоверения. Минимум 2 символа.
                </div>
                <div class="small text-muted mt-1" id="customer-selected-summary">
                  {% if customer_initial_label %}{{ customer_initial_label }}{% else %}Клиент не выбран{% endif %}
                </div>
                {% for error in form.customer.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                      <div class="fw-semibold">Данные выбранного авто</div>
                      <div class="text-muted small">VIN, СТС и год подтягиваются автоматически.</div>
                    </div>
                    <a href="#" class="btn btn-sm btn-outline-secondary d-none" id="car-edit-link" target="_blank" rel="noopener">
                      Edit car
                    </a>
                  </div>
                  <div id="car-details" class="row small gy-1">
                    <div class="col-md-4">
                      <div class="fw-semibold" data-field="plate">—</div>
                      <div class="text-muted" data-field="makeModel">—</div>
                      <div>Год: <span data-field="year">—</span></div>
                    </div>
                    <div class="col-md-4">
                      <div>VIN: <span data-field="vin">—</span></div>
                      <div>СТС: <span data-field="sts_number">—</span></div>
                    </div>
                    <div class="col-md-4">
                      <div>СТС выдана: <span data-field="sts_issue_date">—</span></div>
                      <div>Кем: <span data-field="sts_issued_by">—</span></div>
                    </div>
                  </div>
                  <div class="text-muted small" id="car-details-empty">Выберите авто, чтобы увидеть VIN и СТС.</div>
                </div>
              </div>

              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.start_date.id_for_label }}">Start date</label>
                {{ form.start_date }}
                <div class="form-text">Выберите дату начала аренды.</div>
                {% for error in form.start_date.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.start_time.id_for_label }}">Start time</label>
                {{ form.start_time }}
                <div class="form-text">Нужен для расчёта аэропортового/ночного сбора.</div>
                {% for error in form.start_time.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.end_date.id_for_label }}">End date</label>
                {{ form.end_date }}
                <div class="form-text">Система подставит цену в зависимости от количества дней.</div>
                {% for error in form.end_date.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.end_time.id_for_label }}">End time</label>
                {{ form.end_time }}
                <div class="form-text">Для ночных/аэропортовых сборов при возврате.</div>
                {% for error in form.end_time.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                  <span class="small text-muted">Быстрый выбор длительности:</span>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="3">3 дня</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="7">7 дней</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="14">14 дней</button>
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-days="30">30 дней</button>
                </div>
              </div>

              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.unique_daily_rate.id_for_label }}">Уникальный тариф</label>
                {{ form.unique_daily_rate }}
                <div class="form-text">Перебивает тариф машины на все дни.</div>
                {% for error in form.unique_daily_rate.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.daily_rate.id_for_label }}">Daily rate</label>
                {{ form.daily_rate }}
                <div class="form-text">Автозаполнение по тарифу автомобиля.</div>
                {% for error in form.daily_rate.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.total_price.id_for_label }}">Total price</label>
                {{ form.total_price }}
                <div class="form-text">Сумма договора после доп. услуг и скидок.</div>
                {% for error in form.total_price.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>
              <div class="col-lg-3 col-md-6">
                <label class="form-label" for="{{ form.balance_due.id_for_label }}">К оплате после предоплаты</label>
                {{ form.balance_due }}
                <div class="form-text">Учитывает предоплату.</div>
                {% for error in form.balance_due.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
              </div>

              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="fw-semibold mb-2">Аэропорт, ночной выход, доставка</div>
                  <div class="row g-3">
                    <div class="col-lg-6">
                      <div class="border rounded p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="fw-semibold small mb-0">Выдача</div>
                          <button class="btn btn-sm btn-outline-secondary" type="button" data-time-fill="start">
                            По времени выдачи
                          </button>
                        </div>
                        <div class="row g-2">
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.airport_fee_start.id_for_label }}">Аэропорт</label>
                            {{ form.airport_fee_start }}
                            <div class="form-text">Рассчитывается по времени, можно поправить.</div>
                            {% for error in form.airport_fee_start.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.night_fee_start.id_for_label }}">Ночной выход</label>
                            {{ form.night_fee_start }}
                            <div class="form-text">По таблице ночных выходов.</div>
                            {% for error in form.night_fee_start.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.delivery_issue_city.id_for_label }}">Город выдачи</label>
                            {{ form.delivery_issue_city }}
                            <div class="form-text">Стоимость возьмём из таблицы доставки.</div>
                            {% for error in form.delivery_issue_city.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.delivery_issue_fee.id_for_label }}">Стоимость выдачи</label>
                            {{ form.delivery_issue_fee }}
                            <div class="form-text">Автозаполнение, можно изменить.</div>
                            {% for error in form.delivery_issue_fee.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-6">
                      <div class="border rounded p-3 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div class="fw-semibold small mb-0">Возврат</div>
                          <button class="btn btn-sm btn-outline-secondary" type="button" data-time-fill="end">
                            По времени возврата
                          </button>
                        </div>
                        <div class="row g-2">
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.airport_fee_end.id_for_label }}">Аэропорт</label>
                            {{ form.airport_fee_end }}
                            <div class="form-text">По времени возврата.</div>
                            {% for error in form.airport_fee_end.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.night_fee_end.id_for_label }}">Ночной выход</label>
                            {{ form.night_fee_end }}
                            <div class="form-text">Можно скорректировать вручную.</div>
                            {% for error in form.night_fee_end.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.delivery_return_city.id_for_label }}">Город возврата</label>
                            {{ form.delivery_return_city }}
                            <div class="form-text">Считается отдельно от выдачи.</div>
                            {% for error in form.delivery_return_city.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                          <div class="col-sm-6">
                            <label class="form-label" for="{{ form.delivery_return_fee.id_for_label }}">Стоимость возврата</label>
                            {{ form.delivery_return_fee }}
                            <div class="form-text">Авторасчёт по городу, редактируется.</div>
                            {% for error in form.delivery_return_fee.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="fw-semibold mb-2">Дополнительное оборудование</div>
                  <div class="row g-3 align-items-center">
                    <div class="col-md-4">
                      <div class="form-check">
                        {{ form.child_seat_included }}
                        <label class="form-check-label" for="{{ form.child_seat_included.id_for_label }}">Детское кресло</label>
                      </div>
                      <div class="form-text">200 ₽/сут, максимум 2800 за кресло.</div>
                      {% for error in form.child_seat_included.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        {{ form.booster_included }}
                        <label class="form-check-label" for="{{ form.booster_included.id_for_label }}">Бустер</label>
                      </div>
                      <div class="form-text">100 ₽/сут, максимум 1000 за бустер.</div>
                      {% for error in form.booster_included.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        {{ form.ski_rack_included }}
                        <label class="form-check-label" for="{{ form.ski_rack_included.id_for_label }}">Крепления д/лыж</label>
                      </div>
                      <div class="form-text">400 ₽ в сутки.</div>
                      {% for error in form.ski_rack_included.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        {{ form.roof_box_included }}
                        <label class="form-check-label" for="{{ form.roof_box_included.id_for_label }}">Автобокс</label>
                      </div>
                      <div class="form-text">900 ₽ в сутки.</div>
                      {% for error in form.roof_box_included.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        {{ form.crossbars_included }}
                        <label class="form-check-label" for="{{ form.crossbars_included.id_for_label }}">Поперечины</label>
                      </div>
                      <div class="form-text">300 ₽ в сутки.</div>
                      {% for error in form.crossbars_included.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.equipment_manual_total.id_for_label }}">Фикс. сумма оборудования</label>
                      {{ form.equipment_manual_total }}
                      <div class="form-text">Заполните, если не считать по суткам.</div>
                      {% for error in form.equipment_manual_total.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="border rounded p-3 bg-light">
                  <div class="fw-semibold mb-2">Скидки, предоплата и статус</div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.discount_amount.id_for_label }}">Скидка суммой</label>
                      {{ form.discount_amount }}
                      <div class="form-text">Фиксированная скидка в рублях.</div>
                      {% for error in form.discount_amount.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.discount_percent.id_for_label }}">Скидка %</label>
                      {{ form.discount_percent }}
                      <div class="form-text">Применяется к суточному тарифу после фиксированной скидки. Доп. услуги без скидки.</div>
                      {% for error in form.discount_percent.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.prepayment.id_for_label }}">Предоплата</label>
                      {{ form.prepayment }}
                      <div class="form-text">Вычитается из суммы к оплате.</div>
                      {% for error in form.prepayment.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label" for="{{ form.status.id_for_label }}">Status</label>
                      {{ form.status }}
                      {% for error in form.status.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="col-lg-3">
        <div class="sticky-summary">
          <div class="card shadow-sm" id="price-summary" role="alert">
            <div class="card-body">
              <div class="d-flex align-items-center gap-2 mb-3">
                <div class="spinner-border spinner-border-sm text-primary d-none" id="price-spinner" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                  <div class="fw-semibold text-uppercase small text-muted mb-1">Текущий расчёт</div>
                  <div class="small text-muted" id="price-summary-text">Выберите авто и даты аренды.</div>
                </div>
              </div>
              <div class="bg-light rounded p-3 mb-3">
                <div class="text-muted small">К оплате</div>
                <div class="h4 mb-0" id="price-summary-due">—</div>
              </div>
              <div class="small" id="price-summary-breakdown">
                <div class="d-flex justify-content-between">
                  <span>Дней</span>
                  <span id="price-summary-days">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Тариф</span>
                  <span id="price-summary-rate">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Базово</span>
                  <span id="price-summary-base">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Доп. услуги</span>
                  <span id="price-summary-extras">—</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Скидки</span>
                  <span id="price-summary-discounts">—</span>
                </div>
                <div class="d-flex justify-content-between fw-semibold">
                  <span>Итого</span>
                  <span id="price-summary-total">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if car_pricing %}
      {{ car_pricing|json_script:"car-pricing-data" }}
    {% endif %}
    {% if pricing_config %}
      {{ pricing_config|json_script:"pricing-config-data" }}
    {% endif %}

    <script>
      (function() {
        const searchInput = document.getElementById("customer-search");
        const resultsMenu = document.getElementById("customer-search-results");
        const hiddenField = document.getElementById("id_customer");
        const summary = document.getElementById("customer-selected-summary");
        const editLink = document.getElementById("customer-edit-link");
        const editUrlTemplate = editLink?.dataset.editUrlTemplate;
        const searchUrl = searchInput?.dataset.searchUrl;
        const initialLabel = searchInput?.dataset.initialLabel;
        let debounceTimer = null;
        let activeRequest = null;
        let lastSelectedLabel = initialLabel && hiddenField?.value ? initialLabel : "";

        if (!searchInput || !resultsMenu || !hiddenField || !searchUrl) {
          return;
        }

        function setSummary(text, highlight = false) {
          if (!summary) return;
          summary.textContent = text;
          summary.classList.toggle("text-danger", highlight);
        }

        function clearResults() {
          resultsMenu.innerHTML = "";
          resultsMenu.classList.remove("show");
        }

        function setEditLink(customerId) {
          if (!editLink) return;
          if (!customerId || !editUrlTemplate) {
            editLink.classList.add("disabled");
            editLink.setAttribute("aria-disabled", "true");
            editLink.setAttribute("tabindex", "-1");
            editLink.removeAttribute("href");
            return;
          }
          const url = editUrlTemplate.replace("/0/", `/${customerId}/`);
          editLink.href = url;
          editLink.classList.remove("disabled");
          editLink.removeAttribute("aria-disabled");
          editLink.removeAttribute("tabindex");
        }

        function selectCustomer(item) {
          if (!item) return;
          hiddenField.value = item.id;
          const parts = [item.name, item.phone].filter(Boolean);
          const label = parts.join(" · ") || item.name;
          searchInput.value = item.name;
          lastSelectedLabel = label;
          setSummary(label);
          setEditLink(item.id);
          document.dispatchEvent(new CustomEvent("rental:customer-change", { detail: { name: item.name } }));
          clearResults();
        }

        function renderResults(items) {
          clearResults();
          if (!items.length) {
            const empty = document.createElement("div");
            empty.className = "dropdown-item text-muted small";
            empty.textContent = "Ничего не найдено";
            resultsMenu.appendChild(empty);
            resultsMenu.classList.add("show");
            return;
          }

          items.forEach((item) => {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "dropdown-item text-wrap";
            btn.dataset.id = item.id;

            btn.addEventListener("click", () => selectCustomer(item));

            const title = document.createElement("div");
            title.className = "fw-semibold";
            title.textContent = item.name;

            const meta = document.createElement("div");
            meta.className = "small text-muted";
            const metaParts = [item.phone, item.email, item.license_number].filter(Boolean);
            meta.textContent = metaParts.join(" • ");

            btn.appendChild(title);
            btn.appendChild(meta);
            resultsMenu.appendChild(btn);
          });

          resultsMenu.classList.add("show");
        }

        function fetchResults(term) {
          if (!term) return;

          if (activeRequest) {
            activeRequest.abort();
          }

          const controller = new AbortController();
          activeRequest = controller;

          resultsMenu.innerHTML = '<span class="dropdown-item text-muted small">Ищем...</span>';
          resultsMenu.classList.add("show");

          fetch(`${searchUrl}?q=${encodeURIComponent(term)}`, { signal: controller.signal })
            .then((response) => (response.ok ? response.json() : Promise.reject()))
            .then((data) => {
              if (controller.signal.aborted) return;
              renderResults((data && data.results) || []);
            })
            .catch(() => {
              if (controller.signal.aborted) return;
              clearResults();
              setSummary("Не удалось загрузить клиентов. Попробуйте ещё раз.", true);
            })
            .finally(() => {
              if (activeRequest === controller) {
                activeRequest = null;
              }
            });
        }

        function handleInput() {
          const term = searchInput.value.trim();
          if (term !== lastSelectedLabel && hiddenField.value) {
            hiddenField.value = "";
            setEditLink("");
          }

          if (term.length < 2) {
            clearResults();
            if (!hiddenField.value) {
              setSummary("Введите минимум 2 символа для поиска.", true);
            }
            return;
          }

          setSummary("Выберите клиента из результатов поиска.");

          if (debounceTimer) {
            window.clearTimeout(debounceTimer);
          }
          debounceTimer = window.setTimeout(() => fetchResults(term), 180);
        }

        searchInput.addEventListener("input", handleInput);
        searchInput.addEventListener("focus", () => {
          if (resultsMenu.innerHTML.trim()) {
            resultsMenu.classList.add("show");
          }
        });

        document.addEventListener("click", (event) => {
          if (event.target === searchInput || resultsMenu.contains(event.target)) {
            return;
          }
          clearResults();
        });

        if (initialLabel && hiddenField.value) {
          searchInput.value = initialLabel;
          setSummary(initialLabel);
          setEditLink(hiddenField.value);
          document.dispatchEvent(
            new CustomEvent("rental:customer-change", { detail: { name: searchInput.value || initialLabel } })
          );
        } else if (hiddenField.value) {
          setSummary("Клиент выбран");
          setEditLink(hiddenField.value);
        } else {
          setSummary("Введите минимум 2 символа для поиска.", true);
          setEditLink("");
        }
      })();
    </script>

    <script>
      (function() {
        const carSelect = document.getElementById("id_car");
        const startInput = document.getElementById("id_start_date");
        const endInput = document.getElementById("id_end_date");
        const startTimeInput = document.getElementById("id_start_time");
        const endTimeInput = document.getElementById("id_end_time");
        const dailyRateInput = document.getElementById("id_daily_rate");
        const uniqueRateInput = document.getElementById("id_unique_daily_rate");
        const totalInput = document.getElementById("id_total_price");
        const balanceInput = document.getElementById("id_balance_due");
        const summaryText = document.getElementById("price-summary-text");
        const summaryDays = document.getElementById("price-summary-days");
        const summaryRate = document.getElementById("price-summary-rate");
        const summaryBase = document.getElementById("price-summary-base");
        const summaryExtras = document.getElementById("price-summary-extras");
        const summaryDiscounts = document.getElementById("price-summary-discounts");
        const summaryTotal = document.getElementById("price-summary-total");
        const summaryDue = document.getElementById("price-summary-due");
        const quickButtons = document.querySelectorAll("button[data-days]");
        const contractInput = document.getElementById("id_contract_number");
        const dealPreview = document.getElementById("deal-name-preview");
        const carDetails = document.getElementById("car-details");
        const carDetailsEmpty = document.getElementById("car-details-empty");
        const carEditLink = document.getElementById("car-edit-link");
        const customerSearchInput = document.getElementById("customer-search");
        const airportStartInput = document.getElementById("id_airport_fee_start");
        const airportEndInput = document.getElementById("id_airport_fee_end");
        const nightStartInput = document.getElementById("id_night_fee_start");
        const nightEndInput = document.getElementById("id_night_fee_end");
        const deliveryIssueCity = document.getElementById("id_delivery_issue_city");
        const deliveryReturnCity = document.getElementById("id_delivery_return_city");
        const deliveryIssueFee = document.getElementById("id_delivery_issue_fee");
        const deliveryReturnFee = document.getElementById("id_delivery_return_fee");
        const childSeatToggle = document.getElementById("id_child_seat_included");
        const boosterToggle = document.getElementById("id_booster_included");
        const skiRackToggle = document.getElementById("id_ski_rack_included");
        const roofBoxToggle = document.getElementById("id_roof_box_included");
        const crossbarsToggle = document.getElementById("id_crossbars_included");
        const equipmentManualInput = document.getElementById("id_equipment_manual_total");
        const discountAmountInput = document.getElementById("id_discount_amount");
        const discountPercentInput = document.getElementById("id_discount_percent");
        const prepaymentInput = document.getElementById("id_prepayment");
        const timeFillButtons = document.querySelectorAll("[data-time-fill]");
        const carPricingData = window.JSON.parse((document.getElementById("car-pricing-data") || { textContent: "[]" }).textContent);
        const pricingConfig = window.JSON.parse((document.getElementById("pricing-config-data") || { textContent: "{}" }).textContent);
        let selectedCustomerName = (customerSearchInput?.value || "").trim();
        let currentCar = null;

        const msPerDay = 24 * 60 * 60 * 1000;
        const manualTimeFlags = {
          airportStart: false,
          airportEnd: false,
          nightStart: false,
          nightEnd: false,
        };

        function roundMoney(value) {
          const numeric = Number(value);
          if (!Number.isFinite(numeric)) return 0;
          return Math.round(numeric);
        }

        function parseDate(value) {
          if (!value) return null;
          const normalized = value.replace(/[./]/g, "-");
          const parts = normalized.split("-");
          if (parts.length !== 3) return null;
          let year;
          let month;
          let day;
          if (parts[0].length === 4) {
            year = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
            day = parseInt(parts[2], 10);
          } else if (parts[2].length === 4) {
            day = parseInt(parts[0], 10);
            month = parseInt(parts[1], 10);
            year = parseInt(parts[2], 10);
          } else {
            return null;
          }
          if (!year || !month || !day) return null;
          return new Date(Date.UTC(year, month - 1, day));
        }

        function diffDays(start, end) {
          if (!start || !end) return 0;
          const diff = Math.round((end - start) / msPerDay);
          return diff > 0 ? diff : 0;
        }

        function parseTimeMinutes(value) {
          if (!value) return null;
          const parts = value.split(":");
          if (parts.length !== 2) return null;
          const hours = parseInt(parts[0], 10);
          const minutes = parseInt(parts[1], 10);
          if (Number.isNaN(hours) || Number.isNaN(minutes)) return null;
          return hours * 60 + minutes;
        }

        function slotMinutes(text) {
          const parts = text.split(":");
          if (parts.length !== 2) return 0;
          return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
        }

        function feeByTime(valueMinutes, slots, fallback) {
          if (valueMinutes === null || valueMinutes === undefined) return fallback;
          for (const slot of slots || []) {
            const start = slotMinutes(slot.start || "00:00");
            const end = slotMinutes(slot.end || "00:00");
            if (start <= end) {
              if (valueMinutes >= start && valueMinutes <= end) {
                return slot.amount ?? fallback;
              }
            } else if (valueMinutes >= start || valueMinutes <= end) {
              return slot.amount ?? fallback;
            }
          }
          return fallback;
        }

        function parseNumber(input) {
          if (!input) return 0;
          const raw = String(input.value || "").replace(",", ".").trim();
          const parsed = Number.parseFloat(raw);
          return Number.isFinite(parsed) ? roundMoney(parsed) : 0;
        }

        function setNumber(input, value) {
          if (!input) return;
          input.value = String(roundMoney(value));
        }

        function formatMoney(value) {
          return new Intl.NumberFormat("ru-RU", {
            style: "currency",
            currency: "RUB",
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          }).format(roundMoney(value));
        }

        function pickRate(car, days) {
          if (!car) return 0;
          const tiers = [
            { threshold: 15, high: "rate_15_plus_high", low: "rate_15_plus_low" },
            { threshold: 5, high: "rate_5_14_high", low: "rate_5_14_low" },
            { threshold: 1, high: "rate_1_4_high", low: "rate_1_4_low" },
          ];

          for (const tier of tiers) {
            if (days >= tier.threshold) {
              if (car[tier.high]) return car[tier.high];
              if (car[tier.low]) return car[tier.low];
            }
          }
          return car.daily_rate || 0;
        }

        function setCarDetail(field, value) {
          const el = carDetails?.querySelector(`[data-field="${field}"]`);
          if (el) {
            el.textContent = value || "—";
          }
        }

        function updateCarDetails(car) {
          if (!carDetails || !carDetailsEmpty) return;
          if (!car) {
            setCarDetail("plate", "—");
            setCarDetail("makeModel", "—");
            setCarDetail("year", "—");
            setCarDetail("vin", "—");
            setCarDetail("sts_number", "—");
            setCarDetail("sts_issue_date", "—");
            setCarDetail("sts_issued_by", "—");
            carDetailsEmpty.classList.remove("d-none");
            carDetails.classList.add("opacity-50");
            carEditLink?.classList.add("d-none");
            return;
          }

          setCarDetail("plate", car.plate_number || "—");
          setCarDetail("makeModel", [car.make, car.model].filter(Boolean).join(" ").trim() || "—");
          setCarDetail("year", car.year || "—");
          setCarDetail("vin", car.vin || "—");
          setCarDetail("sts_number", car.sts_number || "—");
          setCarDetail("sts_issue_date", car.sts_issue_date || "—");
          setCarDetail("sts_issued_by", car.sts_issued_by || "—");
          carDetailsEmpty.classList.add("d-none");
          carDetails.classList.remove("opacity-50");
          if (carEditLink) {
            if (car.edit_url) {
              carEditLink.href = car.edit_url;
              carEditLink.classList.remove("d-none");
            } else {
              carEditLink.classList.add("d-none");
            }
          }
        }

        function extractLastName(name) {
          const parts = (name || "").trim().split(/\s+/);
          return parts.length ? parts[0] : "";
        }

        function updateDealPreview(car) {
          if (!dealPreview) return;
          const contract = (contractInput?.value || "").trim() || "#####";
          const lastName = extractLastName(selectedCustomerName) || "Фамилия";
          const carPart = car ? `${car.plate_number} ${car.make}`.trim() : "Авто";
          const datePart = startInput?.value || "дата";
          dealPreview.textContent = `${contract}/${lastName}/${carPart}/${datePart}`;
        }

        function deliveryFeeFor(city) {
          if (!city) return 0;
          return pricingConfig.delivery_fees?.[city] || 0;
        }

        function autoFillDelivery(selectEl, feeEl) {
          if (!selectEl || !feeEl) return;
          const fee = deliveryFeeFor(selectEl.value || "");
          setNumber(feeEl, fee);
        }

        function autoFillTimeFees(target, { force = false } = {}) {
          const isStart = target === "start";
          const minutes = parseTimeMinutes(isStart ? startTimeInput?.value : endTimeInput?.value);
          const airportInput = isStart ? airportStartInput : airportEndInput;
          const nightInput = isStart ? nightStartInput : nightEndInput;
          const airportKey = isStart ? "airportStart" : "airportEnd";
          const nightKey = isStart ? "nightStart" : "nightEnd";
          const airportFee = feeByTime(minutes, pricingConfig.airport_slots || [], pricingConfig.airport_default || 0);
          const nightFee = feeByTime(minutes, pricingConfig.night_slots || [], pricingConfig.night_default || 0);

          if (airportInput && (!manualTimeFlags[airportKey] || force || !airportInput.value)) {
            setNumber(airportInput, airportFee);
          }
          if (nightInput && (!manualTimeFlags[nightKey] || force || !nightInput.value)) {
            setNumber(nightInput, nightFee);
          }
        }

        function clearSummary() {
          if (summaryDays) summaryDays.textContent = "—";
          if (summaryRate) summaryRate.textContent = "—";
          if (summaryBase) summaryBase.textContent = "—";
          if (summaryExtras) summaryExtras.textContent = "—";
          if (summaryDiscounts) summaryDiscounts.textContent = "—";
          if (summaryTotal) summaryTotal.textContent = "—";
          if (summaryDue) summaryDue.textContent = "—";
        }

        function calculatePricing(forceWrite = false) {
          const carId = Number(carSelect?.value);
          currentCar = carPricingData.find((item) => item.id === carId);
          const startDate = parseDate(startInput?.value);
          const endDate = parseDate(endInput?.value);
          const days = diffDays(startDate, endDate);

          updateCarDetails(currentCar);
          updateDealPreview(currentCar);

          if (!currentCar || !days) {
            if (forceWrite) {
              setNumber(dailyRateInput, 0);
              setNumber(totalInput, 0);
              setNumber(balanceInput, 0);
            }
            clearSummary();
            if (summaryText) {
              summaryText.textContent = "Выберите авто и корректные даты аренды.";
            }
            return;
          }

          const uniqueRate = parseNumber(uniqueRateInput);
          const baseRate = roundMoney(uniqueRate > 0 ? uniqueRate : pickRate(currentCar, days));
          const baseTotal = roundMoney(baseRate * days);

          if (airportStartInput && !airportStartInput.value && !manualTimeFlags.airportStart) {
            setNumber(airportStartInput, pricingConfig.airport_default || 0);
          }
          if (airportEndInput && !airportEndInput.value && !manualTimeFlags.airportEnd) {
            setNumber(airportEndInput, pricingConfig.airport_default || 0);
          }
          if (nightStartInput && !nightStartInput.value && !manualTimeFlags.nightStart) {
            setNumber(nightStartInput, pricingConfig.night_default || 0);
          }
          if (nightEndInput && !nightEndInput.value && !manualTimeFlags.nightEnd) {
            setNumber(nightEndInput, pricingConfig.night_default || 0);
          }

          const airportTotal = roundMoney(parseNumber(airportStartInput) + parseNumber(airportEndInput));
          const nightTotal = roundMoney(parseNumber(nightStartInput) + parseNumber(nightEndInput));
          const deliveryTotal = roundMoney(parseNumber(deliveryIssueFee) + parseNumber(deliveryReturnFee));

          const seatsPerUnit = Math.min(
            days * (pricingConfig.child_seat_daily || 0),
            pricingConfig.child_seat_cap || 0
          );
          const boosterPerUnit = Math.min(
            days * (pricingConfig.booster_daily || 0),
            pricingConfig.booster_cap || 0
          );
          const seatsTotal = roundMoney(seatsPerUnit * (childSeatToggle?.checked ? 1 : 0));
          const boostersTotal = roundMoney(boosterPerUnit * (boosterToggle?.checked ? 1 : 0));

          const gearPerDay =
            (pricingConfig.ski_rack_daily || 0) * (skiRackToggle?.checked ? 1 : 0) +
            (pricingConfig.autobox_daily || 0) * (roofBoxToggle?.checked ? 1 : 0) +
            (pricingConfig.crossbars_daily || 0) * (crossbarsToggle?.checked ? 1 : 0);
          const gearTotal = roundMoney(gearPerDay * days);

          const manualEquipment = Math.max(parseNumber(equipmentManualInput), 0);
          const equipmentTotal = manualEquipment > 0 ? roundMoney(manualEquipment) : roundMoney(seatsTotal + boostersTotal + gearTotal);

          const extras = roundMoney(airportTotal + nightTotal + deliveryTotal + equipmentTotal);
          const subtotal = roundMoney(baseTotal + extras);

          const discountAmount = Math.min(Math.max(parseNumber(discountAmountInput), 0), subtotal);
          const discountPercent = Math.min(Math.max(parseNumber(discountPercentInput), 0), 100);
          const percentBase = Math.max(baseTotal, 0);
          let discountPercentAmount = roundMoney(percentBase * (discountPercent / 100));
          const maxPercentDiscount = Math.max(subtotal - discountAmount, 0);
          if (discountPercentAmount > maxPercentDiscount) {
            discountPercentAmount = maxPercentDiscount;
          }

          const contractTotal = roundMoney(subtotal - discountAmount - discountPercentAmount);
          const prepayment = Math.max(parseNumber(prepaymentInput), 0);
          const due = roundMoney(Math.max(contractTotal - prepayment, 0));

          setNumber(dailyRateInput, baseRate);
          setNumber(totalInput, contractTotal);
          setNumber(balanceInput, due);

          const discountsTotal = roundMoney(discountAmount + discountPercentAmount);
          if (summaryText) {
            summaryText.textContent = [
              `${days} дн × ${formatMoney(baseRate)} = ${formatMoney(baseTotal)}`,
              `доп. услуги ${formatMoney(extras)}`,
              `скидки ${formatMoney(discountsTotal)}`,
              `предоплата ${formatMoney(prepayment)}`,
            ].join(" · ");
          }

          if (summaryDays) summaryDays.textContent = `${days}`;
          if (summaryRate) summaryRate.textContent = formatMoney(baseRate);
          if (summaryBase) summaryBase.textContent = formatMoney(baseTotal);
          if (summaryExtras) summaryExtras.textContent = formatMoney(extras);
          if (summaryDiscounts) summaryDiscounts.textContent = `-${formatMoney(discountsTotal)}`;
          if (summaryTotal) summaryTotal.textContent = formatMoney(contractTotal);
          if (summaryDue) summaryDue.textContent = formatMoney(due);
        }

        quickButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const days = Number(btn.getAttribute("data-days") || "0");
            const startDate = parseDate(startInput?.value) || new Date();
            const endDate = new Date(startDate.getTime() + days * msPerDay);
            const format = (date) => {
              const y = date.getUTCFullYear();
              const m = String(date.getUTCMonth() + 1).padStart(2, "0");
              const d = String(date.getUTCDate()).padStart(2, "0");
              return `${d}-${m}-${y}`;
            };
            if (startInput && !startInput.value) {
              startInput.value = format(startDate);
            }
            if (endInput) {
              endInput.value = format(endDate);
            }
            autoFillTimeFees("start");
            autoFillTimeFees("end");
            calculatePricing(true);
          });
        });

        [
          carSelect,
          startInput,
          endInput,
          uniqueRateInput,
          airportStartInput,
          airportEndInput,
          nightStartInput,
          nightEndInput,
          deliveryIssueFee,
          deliveryReturnFee,
          childSeatToggle,
          boosterToggle,
          skiRackToggle,
          roofBoxToggle,
          crossbarsToggle,
          equipmentManualInput,
          discountAmountInput,
          discountPercentInput,
          prepaymentInput,
        ].forEach((el) => {
          if (el) {
            el.addEventListener("change", () => calculatePricing(true));
            el.addEventListener("input", () => calculatePricing(true));
          }
        });

        [startTimeInput, endTimeInput].forEach((el) => {
          if (!el) return;
          el.addEventListener("change", () => {
            autoFillTimeFees(el === startTimeInput ? "start" : "end");
            calculatePricing(true);
          });
          el.addEventListener("input", () => {
            autoFillTimeFees(el === startTimeInput ? "start" : "end");
            calculatePricing(true);
          });
        });

        [
          [airportStartInput, "airportStart"],
          [airportEndInput, "airportEnd"],
          [nightStartInput, "nightStart"],
          [nightEndInput, "nightEnd"],
        ].forEach(([input, key]) => {
          if (!input) return;
          input.addEventListener("input", () => {
            manualTimeFlags[key] = Boolean((input.value || "").trim());
            calculatePricing(true);
          });
        });

        [deliveryIssueCity, deliveryReturnCity].forEach((el) => {
          if (!el) return;
          el.addEventListener("change", () => {
            autoFillDelivery(el, el === deliveryIssueCity ? deliveryIssueFee : deliveryReturnFee);
            calculatePricing(true);
          });
        });

        timeFillButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-time-fill");
            if (target === "start") {
              manualTimeFlags.airportStart = false;
              manualTimeFlags.nightStart = false;
            } else if (target === "end") {
              manualTimeFlags.airportEnd = false;
              manualTimeFlags.nightEnd = false;
            }
            autoFillTimeFees(target, { force: true });
            calculatePricing(true);
          });
        });

        customerSearchInput?.addEventListener("input", () => {
          selectedCustomerName = customerSearchInput.value.trim();
          updateDealPreview(currentCar);
        });

        document.addEventListener("rental:customer-change", (event) => {
          selectedCustomerName = (event.detail?.name || "").trim();
          updateDealPreview(currentCar);
        });

        contractInput?.addEventListener("input", () => updateDealPreview(currentCar));

        [
          uniqueRateInput,
          airportStartInput,
          airportEndInput,
          nightStartInput,
          nightEndInput,
          deliveryIssueFee,
          deliveryReturnFee,
          equipmentManualInput,
          discountAmountInput,
          prepaymentInput,
        ].forEach((el) => {
          if (el && (el.value || "").trim()) {
            setNumber(el, parseNumber(el));
          }
        });

        if (!((airportStartInput?.value || "").trim() || (nightStartInput?.value || "").trim())) {
          autoFillTimeFees("start");
        }
        if (!((airportEndInput?.value || "").trim() || (nightEndInput?.value || "").trim())) {
          autoFillTimeFees("end");
        }
        calculatePricing(true);
      })();
    </script>

    <div class="d-flex justify-content-end gap-2 pt-3">
      <a href="{% url 'rentals:rental_list' %}" class="btn btn-outline-secondary">Cancel</a>
      <button class="btn btn-primary" type="submit">Save rental</button>
    </div>
  </form>
{% endblock %}
